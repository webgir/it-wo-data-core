# Пайплайн IWDC v0.6 — Архитектура сборки данных

IWDC v0.6 реализует **промышленный пайплайн сборки данных** с многоуровневой системой аудита и контроля качества.

## Принцип работы

**Строгий принцип пайплайна:**

> Если один из аудитов возвращает статус `error` — сборка останавливается.

Каждый уровень отвечает за свою зону ответственности и гарантирует, что любые изменения данных являются корректными, согласованными и задокументированными.

## Финальная цепочка IWDC v0.6

```
validate → audit-structure → audit-seo → bc-validator
→ integrity → snapshot → diff → data-semver → changelog
```

## Уровни пайплайна

### 1. Контрактный уровень (Schema Validation)

**Модуль:** `scripts/audit/validate-contracts.mjs`

**Цель:** Проверка соответствия данных JSON Schema.

**Проверяет:**
- `series.schema.json`
- `model.schema.json`
- `length.schema.json`
- `seo.schema.json`
- `meta.schema.json`

**Что проверяется:**
- Корректность типов
- Обязательные поля
- Вложенные структуры
- Формат значений

**Результат:**
- Любое несовпадение схемы → `status: "error"`
- Сборка останавливается

---

### 2. Структурный уровень (Graph Consistency Audit)

**Модуль:** `scripts/audit/audit-structure.mjs`

**Цель:** Проверка согласованности графа сущностей.

**Проверяет:**
- Уникальность `id` и `slug`
- Ссылки `model → series` (через `series_slug`)
- Ссылки `length → model` (через `model_slug`)
- Связи `SEO → модель/длина` (через `entity_slug`)
- Отсутствие «сиротских» объектов

**Результат:**
- Любой разрыв в связях → `error`
- Сборка останавливается

---

### 3. Контентный уровень (SEO Audit)

**Модуль:** `scripts/audit/audit-seo.mjs`

**Цель:** Проверка качества текстовых полей.

**Проверяет:**
- `title`: 30–70 знаков
- `description`: 80–200 знаков
- `h1`: не пустой, содержит `entity_slug`
- Отсутствие мусора (TODO, Lorem, заглушек)
- Отсутствие дублей

**Результат:**
- Ошибки → `error` (останавливает сборку)
- Слабые места → `warning` (не останавливает)

---

### 4. Уровень совместимости (BC Validator)

**Модуль:** `scripts/audit/bc-validator.mjs`

**Цель:** Проверка обратной совместимости с предыдущей версией.

**Сравнивает:** текущие данные с последним snapshot.

**Проверяет:**
- Удаление `series/models/lengths` → **breaking**
- Изменение ID → **breaking**
- Изменение типа поля → **breaking**
- Удаление обязательных полей → **breaking**

**Результат:**
- Любое breaking-изменение → `error`
- Сборка останавливается

---

### 5. Уровень целостности (Integrity Audit)

**Модуль:** `scripts/audit/integrity.mjs`  
**Использует:** `scripts/integrity.mjs`

**Цель:** Гарантия, что данные не были изменены «молчаливо».

**Процесс:**
1. Вычисляет SHA256 всех файлов в `data/json/`
2. Сравнивает с `integrity` предыдущего snapshot
3. Если файл изменился, но это не отражено в diff → **silent change** → `error`

**Результат:**
- Незадокументированные изменения → `error`
- Сборка останавливается
- Предотвращает «ручные» правки и делает систему детерминированной

---

### 6. Снимок данных (Snapshot)

**Модуль:** `scripts/snapshot-version.mjs`

**Цель:** Фиксация состояния данных после успешного прохождения всех аудитов.

**Процесс:**
1. Создаёт директорию `data/versions/<version>`
2. Копирует туда актуальные JSON-файлы
3. Генерирует `integrity.json` (набор хэшей)
4. Сохраняет `meta.json` с мета-информацией

**Результат:**
- Версия данных зафиксирована
- Можно сравнивать с будущими версиями

---

### 7. Анализ изменений (Data Diff)

**Модуль:** `scripts/diff.mjs`

**Цель:** Извлечение разницы между текущими данными и snapshot.

**Анализирует:**
- Добавленные сущности
- Удалённые сущности
- Изменённые сущности
- Структурные расхождения

**Результат:**
- Структурированный diff-файл
- Используется всеми последующими этапами

---

### 8. Семантическая версия (Data SemVer)

**Модуль:** `scripts/audit/data-semver.mjs`  
**Использует:** `scripts/data-semver.mjs`

**Цель:** Определение уровня версии на основе diff.

**Анализирует изменения:**
- **MAJOR** — удаление сущностей, изменение ID, типов, обязательных полей
- **MINOR** — добавление новых моделей, длин, серий
- **PATCH** — изменения текстов, чисел, не влияющие на структуру

**Выдаёт рекомендацию:**
```json
{
  "level": "major" | "minor" | "patch",
  "reasons": ["Удалены модели", "Изменены типы полей"],
  "recommendedVersion": "1.3.0"
}
```

---

### 9. Журнал изменений (Changelog)

**Модуль:** `scripts/changelog.mjs`

**Цель:** Генерация документации изменений.

**Генерирует:**
- Markdown-версию changelog
- JSON-структуру для автоматической обработки

**Использует:**
- Diff (структура изменений)
- Семантический уровень версии (для заголовков)

---

## Запуск пайплайна

### Через CLI

```bash
npm run iwdc:build
# или
node tools/cli/iwdc-build.mjs
```

### Что происходит

1. **Валидация** — проверка схем
2. **Content Audit Layer** — все аудиты (contracts, structure, seo, bc)
3. **Integrity Check** — проверка целостности
4. **Snapshot** — создание снимка версии
5. **Diff** — сравнение версий
6. **SemVer** — анализ изменений
7. **Changelog** — генерация журнала
8. **Отчёт** — итоговая статистика

### Результат

- При успехе: новая версия в `data/versions/`, diff в `data/diffs/`, changelog в `data/changelog/`
- При ошибке: сборка останавливается, ошибки выводятся в консоль

---

## Интеграция с CI/CD

Пайплайн IWDC может запускаться:

- Перед сборкой сайтов
- В отдельном репозитории для периодических обновлений
- В CI/CD pipeline для автоматической проверки данных

**Минимальный сценарий:**
```bash
iwdc-build.mjs → проверка exit code → деплой клиентов
```

---

## Защита данных

IWDC v0.6 выводит систему на уровень **промышленного ядра данных**:

- ✅ Данные защищены (многоуровневая валидация)
- ✅ Любые изменения фиксируются (snapshot, diff, changelog)
- ✅ Ошибки не проходят (строгий принцип остановки)
- ✅ Система детерминирована (integrity check)
- ✅ Версионирование автоматизировано (Data SemVer)

---

## См. также

- `docs/api-contracts.md` — спецификация Data Contracts
- `docs/validation.md` — правила валидации
- `docs/diff-changelog.md` — форматы diff и changelog
- `docs/architecture.md` — общая архитектура IWDC


