# IWDC Predictive Integrity Layer (v0.8)

Predictive Integrity Layer — система предиктивного анализа данных IWDC, которая выявляет потенциальные проблемы ДО основной сборки, предсказывая нарушения целостности и breaking changes.

---

## 1. Назначение

Predictive Integrity Layer решает следующие задачи:

### 1.1. Раннее обнаружение проблем
- Анализ данных перед основной валидацией и сборкой
- Предсказание потенциальных breaking changes
- Выявление рисков нарушения целостности данных

### 1.2. Предиктивный анализ
- Эвристический анализ паттернов данных
- Проверка консистентности идентификаторов
- Мягкий diff с последней успешной версией
- Предупреждения о подозрительных изменениях

### 1.3. Неблокирующий режим
- Анализ выполняется в начале сборки, но не блокирует её
- Только предупреждает о потенциальных проблемах
- Позволяет разработчику принять решение о продолжении сборки

### 1.4. Детальная отчётность
- JSON-отчёты с полной информацией
- Текстовые логи для быстрого просмотра
- Интеграция с основным процессом сборки

---

## 2. Архитектура

### 2.1. Ключевые модули

#### `scripts/predictive/predictive-core.mjs`
Оркестратор предиктивного слоя:
- `runPredictiveAnalysis({ lastSuccessfulVersion, strict })` — основная функция анализа
- Координирует работу всех модулей предиктивного анализа
- Загружает текущие данные и данные предыдущей версии
- Собирает результаты всех проверок
- Сохраняет отчёты и логи

**Процесс анализа:**
1. Загрузка recovery state для получения последней успешной версии
2. Загрузка текущих данных из `data/json/`
3. Загрузка данных предыдущей версии (если доступна)
4. Запуск модулей анализа:
   - Эвристики (`heuristics.mjs`)
   - Проверка консистентности ID/slug (`id-consistency.mjs`)
   - Предиктивный diff (`predictive-diff.mjs`)
5. Подсчёт итоговой статистики
6. Сохранение отчёта и лога

#### `scripts/predictive/heuristics.mjs`
Модуль эвристического анализа:
- `runHeuristics(currentData, previousData)` — эвристический анализ

**Эвристики:**
- Анализ изменений в количестве сущностей (предупреждение при >50%, ошибка при массовом удалении >30%)
- Обнаружение подозрительных паттернов (пустые объекты, минимальные объекты)
- Проверка рисков нарушения связей (осиротевшие модели/длины)
- Анализ стабильности ID (высокая текучесть >20%)

#### `scripts/predictive/id-consistency.mjs`
Модуль проверки консистентности идентификаторов:
- `checkIdConsistency(currentData, previousData)` — проверка консистентности

**Проверки:**
- Уникальность ID внутри категорий (ошибка при дубликатах)
- Уникальность slug внутри категорий (предупреждение при дубликатах)
- Консистентность между ID и slug (предупреждение при несоответствиях)
- Стабильность ID между версиями (ошибка при изменении ID для того же slug)
- Конфликты идентификаторов между категориями (предупреждения)

#### `scripts/predictive/predictive-diff.mjs`
Модуль предиктивного diff:
- `runPredictiveDiff(currentData, previousData)` — мягкий diff с предыдущей версией

**Анализ изменений:**
- Удалённые сущности (ошибка)
- Удалённые поля (ошибка для критичных, предупреждение для остальных)
- Изменение типов полей (ошибка для критичных, предупреждение для остальных)
- Изменение критичных полей (id, slug, seriesId, modelId и т.д.)
- Изменение связей между сущностями (изменение seriesId у моделей, modelId у длин)

#### `scripts/predictive/predictive-report.mjs`
Модуль записи отчётов и логов:
- `savePredictiveReport(analysisResult)` — сохранение JSON-отчёта
- `savePredictiveLog(analysisResult)` — сохранение текстового лога
- `savePredictiveAnalysis(analysisResult)` — сохранение отчёта и лога

### 2.2. Директории Predictive Layer

```
data/
  predictive/
    reports/              # JSON-отчёты предиктивного анализа
      predictive-<timestamp>.json
    logs/                 # Текстовые логи анализа
      predictive-<timestamp>.log
```

### 2.3. Структура отчёта

**JSON-отчёт (`predictive-{timestamp}.json`):**
```json
{
  "timestamp": "2025-01-15T15:00:00.000Z",
  "status": "warning",
  "lastSuccessfulVersion": "20250115-143022",
  "warnings": [...],
  "errors": [...],
  "heuristics": {
    "warnings": [...],
    "errors": [...],
    "stats": {...}
  },
  "idConsistency": {
    "warnings": [...],
    "errors": [...],
    "stats": {...}
  },
  "predictiveDiff": {
    "warnings": [...],
    "errors": [...],
    "stats": {...}
  },
  "summary": {
    "totalWarnings": 5,
    "totalErrors": 2,
    "criticalIssues": 1
  },
  "reportPath": "...",
  "logPath": "..."
}
```

---

## 3. Функции Predictive Layer

### 3.1. Эвристический анализ

**Модуль:** `scripts/predictive/heuristics.mjs`

**Процесс:**
1. Анализ изменений в количестве сущностей
2. Обнаружение подозрительных паттернов
3. Проверка рисков нарушения связей
4. Анализ стабильности идентификаторов

**Типы предупреждений:**
- `SIGNIFICANT_COUNT_CHANGE` — значительное изменение количества (>50%)
- `MASS_REMOVAL` — массовое удаление (>30%)
- `EMPTY_OBJECTS` — пустые объекты
- `MINIMAL_OBJECTS` — минимальные объекты (>10% от общего количества)
- `ORPHANED_MODELS` — модели без соответствующих серий
- `ORPHANED_LENGTHS` — длины без соответствующих моделей
- `HIGH_ID_CHURN` — высокая текучесть ID (>20%)

### 3.2. Проверка консистентности ID/slug

**Модуль:** `scripts/predictive/id-consistency.mjs`

**Процесс:**
1. Проверка уникальности ID внутри категорий
2. Проверка уникальности slug внутри категорий
3. Проверка консистентности между ID и slug
4. Проверка стабильности ID между версиями
5. Проверка конфликтов между категориями

**Типы проблем:**
- `MISSING_ID` — отсутствие ID (ошибка)
- `DUPLICATE_ID` — дубликат ID (ошибка)
- `DUPLICATE_SLUG` — дубликат slug (предупреждение)
- `ID_SLUG_MISMATCH` — несоответствие ID и slug (предупреждение)
- `ID_CHANGED` — изменение ID для того же slug (ошибка)
- `CROSS_CATEGORY_ID_CONFLICT` — конфликт ID между категориями (предупреждение)
- `CROSS_CATEGORY_SLUG_CONFLICT` — конфликт slug между категориями (предупреждение)

### 3.3. Предиктивный diff

**Модуль:** `scripts/predictive/predictive-diff.mjs`

**Процесс:**
1. Сравнение текущих данных с предыдущей версией
2. Анализ добавленных/удалённых/изменённых сущностей
3. Обнаружение подозрительных изменений
4. Анализ рисков нарушения связей

**Типы проблем:**
- `ENTITY_REMOVED` — удаление сущности (ошибка)
- `FIELD_REMOVED` — удаление поля (ошибка для критичных, предупреждение для остальных)
- `FIELD_TYPE_CHANGED` — изменение типа поля (ошибка для критичных, предупреждение для остальных)
- `CRITICAL_FIELD_CHANGED` — изменение критичного поля (ошибка)
- `SERIES_ID_CHANGED` — изменение привязки модели к серии (ошибка)
- `MODEL_ID_CHANGED` — изменение привязки длины к модели (ошибка)

**Критичные поля:**
- `series`: id, slug, name
- `models`: id, slug, seriesId, model_code
- `lengths`: id, slug, modelId, length

### 3.4. Сохранение отчётов

**Модуль:** `scripts/predictive/predictive-report.mjs`

**Процесс:**
1. Сохранение JSON-отчёта в `data/predictive/reports/`
2. Сохранение текстового лога в `data/predictive/logs/`
3. Автоматическое создание директорий при необходимости

**Формат лога:**
- Заголовок и метаданные
- Summary (warnings, errors, critical issues)
- Детальный список warnings
- Детальный список errors
- Детали по модулям (heuristics, idConsistency, predictiveDiff)

---

## 4. Интеграция со сборкой (iwdc-build)

Predictive Integrity Layer интегрирован в основной процесс сборки IWDC.

### 4.1. Место в пайплайне

Предиктивный анализ выполняется **в начале сборки** (ШАГ 0), до основной валидации:

```
predictive → validate → audit → integrity → snapshot → diff → semver → changelog
```

### 4.2. Процесс выполнения

1. **Загрузка recovery state:**
   - Получение `lastSuccessfulVersion` из recovery state
   - Если версия не найдена, анализ выполняется в ограниченном режиме

2. **Загрузка данных:**
   - Текущие данные из `data/json/`
   - Данные предыдущей версии из `data/versions/{version}/json/`

3. **Запуск модулей анализа:**
   - Эвристики
   - Проверка консистентности ID/slug
   - Предиктивный diff (если есть предыдущая версия)

4. **Сохранение результатов:**
   - JSON-отчёт в `data/predictive/reports/`
   - Текстовый лог в `data/predictive/logs/`

5. **Логирование:**
   - Предупреждения при обнаружении ошибок
   - Информация при обнаружении предупреждений
   - Успех, если проблем нет

### 4.3. Неблокирующий режим

- **Ошибки предиктивного анализа не блокируют сборку**
- Анализ выполняется с `strict: false`
- Только предупреждает о потенциальных проблемах
- Позволяет разработчику принять решение о продолжении

### 4.4. Результаты в итоговом отчёте

Результаты предиктивного анализа включаются в итоговый отчёт сборки:
- Статус анализа
- Количество предупреждений и ошибок
- Путь к сохранённому отчёту

---

## 5. CLI-интерфейс

### 5.1. `analyze [--version <version>] [--strict]`

Запустить предиктивный анализ.

```bash
node tools/cli/iwdc-predict.mjs analyze
node tools/cli/iwdc-predict.mjs analyze --version 20250115-143022
node tools/cli/iwdc-predict.mjs analyze --strict
```

**Параметры:**
- `--version <version>` — использовать указанную версию для сравнения (по умолчанию используется из recovery state)
- `--strict` — строгий режим (прерывать при критических проблемах)

**Процесс:**
- Загружает текущие данные
- Загружает данные предыдущей версии (если указана или найдена в recovery state)
- Запускает все модули анализа
- Сохраняет отчёт и лог
- Выводит краткий summary

**Exit code:**
- `0` — анализ завершён успешно (нет ошибок)
- `1` — есть ошибки или критическая ошибка выполнения

### 5.2. `report`

Показать последний отчёт.

```bash
node tools/cli/iwdc-predict.mjs report
```

**Процесс:**
- Находит последний отчёт в `data/predictive/reports/`
- Выводит краткую информацию (статус, количество предупреждений/ошибок)
- Показывает путь к файлу и время создания

---

## 6. Логи и отчёты

### 6.1. JSON-отчёты

**Директория:** `data/predictive/reports/`

**Формат файлов:** `predictive-{timestamp}.json`

**Содержимое:**
- Полная структура результата анализа
- Все предупреждения и ошибки
- Детали по каждому модулю
- Статистика и summary

### 6.2. Текстовые логи

**Директория:** `data/predictive/logs/`

**Формат файлов:** `predictive-{timestamp}.log`

**Содержимое:**
- Заголовок и метаданные
- Summary (warnings, errors, critical issues)
- Детальный список warnings с категориями и ID
- Детальный список errors с категориями и ID
- Детали по модулям (heuristics, idConsistency, predictiveDiff)

---

## 7. Жизненный цикл Predictive Layer

### 7.1. Выполнение в сборке

```
iwdc-build запущен
  ↓
ШАГ 0: Предиктивный анализ
  ↓
Загрузка recovery state
  ↓
Загрузка текущих данных
  ↓
Загрузка данных предыдущей версии (если доступна)
  ↓
Запуск модулей анализа:
  - Эвристики
  - Консистентность ID/slug
  - Предиктивный diff
  ↓
Сохранение отчёта и лога
  ↓
Логирование результатов
  ↓
Продолжение сборки (не блокируется)
```

### 7.2. Самостоятельный запуск

```
iwdc-predict analyze
  ↓
Запуск предиктивного анализа
  ↓
Сохранение отчёта и лога
  ↓
Вывод summary
  ↓
Exit code: 0 (успех) или 1 (ошибки)
```

---

## 8. Типы проблем и их критичность

### 8.1. Критичные ошибки (severity: "error")

- Удаление сущностей
- Удаление критичных полей (id, slug, seriesId, modelId)
- Изменение типов критичных полей
- Изменение критичных полей
- Изменение привязок между сущностями (seriesId, modelId)
- Дубликаты ID
- Изменение ID для того же slug
- Массовое удаление (>30%)
- Осиротевшие модели/длины

### 8.2. Предупреждения (severity: "warning")

- Значительное изменение количества (>50%)
- Пустые или минимальные объекты
- Дубликаты slug
- Несоответствие ID и slug
- Высокая текучесть ID (>20%)
- Конфликты идентификаторов между категориями
- Удаление некритичных полей
- Изменение типов некритичных полей

---

## 9. Рекомендации по использованию

### 9.1. Регулярный запуск

Рекомендуется запускать предиктивный анализ перед каждой сборкой:

```bash
node tools/cli/iwdc-predict.mjs analyze
```

### 9.2. Анализ перед большими изменениями

Перед внесением значительных изменений в данные:

```bash
node tools/cli/iwdc-predict.mjs analyze --strict
```

Строгий режим поможет выявить все потенциальные проблемы.

### 9.3. Просмотр последнего отчёта

После сборки можно просмотреть последний отчёт:

```bash
node tools/cli/iwdc-predict.mjs report
```

### 9.4. Анализ конкретной версии

Для сравнения с конкретной версией:

```bash
node tools/cli/iwdc-predict.mjs analyze --version 20250115-143022
```

---

## 10. Ограничения и известные проблемы

1. **Требуется lastSuccessfulVersion:** без неё предиктивный анализ выполняется в ограниченном режиме (без diff)
2. **Производительность:** анализ может быть медленным для больших объёмов данных
3. **Ложные срабатывания:** некоторые эвристики могут давать ложные предупреждения
4. **Глубокое сравнение:** использует JSON.stringify, что может быть медленно для больших объектов

---

## 11. См. также

- `docs/pipeline.md` — общий пайплайн IWDC
- `docs/recovery.md` — Recovery Layer (v0.7)
- `docs/technical-summary-v0.6.md` — техническое резюме механизмов
- `tools/cli/iwdc-predict.mjs` — CLI для предиктивного анализа


