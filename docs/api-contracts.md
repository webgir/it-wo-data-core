# API Contracts

---

## `docs/pipeline.md`

```markdown
# Пайплайн IWDC (XLS → CSV → JSON → Validation → Diff)

Этот документ описывает общий процесс обработки данных в IWDC.

## 1. Общий сценарий

1. Получить или обновить исходный XLS/XLSX в `sources/xls/`.
2. Запустить конвейер:
   - `scripts/xls-to-csv.mjs`
   - `scripts/csv-to-json.mjs`
   - `scripts/validate.mjs`
3. При необходимости:
   - `scripts/diff.mjs`
   - `scripts/changelog.mjs`
4. Использовать обновлённый `data/json` в клиентах (сайты, API).

## 2. Этап 1: XLS → CSV

- Вход:
  - `sources/xls/*.xlsx`
- Выход:
  - `intermediate/csv/models.csv`
  - `intermediate/csv/lengths.csv`
  - `intermediate/csv/seo.csv`
  - `intermediate/csv/texts.csv`
- Конфигурация:
  - описана в `docs/xls-mapping.md`.

## 3. Этап 2: CSV → JSON

- Вход:
  - CSV-файлы из `intermediate/csv/`.
- Выход:
  - `data/json/series/*.json`
  - `data/json/models/*.json`
  - `data/json/lengths/*/*.json`
- Правила маппинга:
  - описаны в `docs/csv-json.md`.

## 4. Этап 3: Валидация

- Вход:
  - все JSON-файлы из `data/json/`.
- Инструменты:
  - JSON Schema (`schemas/*.schema.json`).
  - Доменные проверки (диапазоны, связность, статусы).
- Результат:
  - exit code 0 — всё корректно.
  - exit code != 0 — выявлены ошибки, билд останавливается.

Подробнее в `docs/validation.md`.

## 5. Этап 4: Diff и Changelog

- Сравнение текущего JSON-слоя с предыдущей версией.
- Генерация:
  - машинного diff (для CI/логов).
  - человекочитаемого changelog (для команды/клиентов).
- Форматы описаны в `docs/diff-changelog.md`.

## 6. Интеграция с CI/CD

- Пайплайн IWDC может запускаться:
  - перед сборкой сайтов.
  - в отдельном репозитории для периодических обновлений.
- Минимальный сценарий:
  - `iwdc-build.mjs` → `iwdc-validate.mjs` → деплой клиентов.

Подробности интеграции зависят от окружения и описываются в CI-конфиге конкретного проекта.

## 4. Спецификация данных IWDC v0.5

### 4.1. Series Data Contract

#### 4.1.1. Назначение

Сущность Series описывает продуктовые линейки (серии оборудования, коллекции товаров и т.п.).

Этот слой служит входной точкой для навигации и привязки моделей, SEO и бизнес-логики.

Series — это:

- человекочитаемое представление линейки (название, описание);
- машинный идентификатор для связки с models, lengths, seo, meta;
- точка стабильности для внешних систем (Vitron/Wilma/Aleri/ArtMuse).

#### 4.1.2. Формат файла series.json

Файл `data/json/series/series.json` имеет следующий формат верхнего уровня:

```json
[
  { /* Series object */ },
  { /* Series object */ }
]
```

- Тип корня: массив объектов
- Каждый элемент массива — один объект Series
- Порядок элементов не влияет на семантику, но может использоваться для сортировки по умолчанию

#### 4.1.3. Структура объекта Series

Общий вид объекта:

```json
{
  "id": "series.vk",
  "code": "VK",
  "slug": "vk",
  "title": "Внутрипольные конвекторы VK",
  "title_en": "Floor convectors VK",
  "short_title": "VK",
  "description": "Текст описания серии...",
  "description_en": "Series description...",
  "category": "heating_convector",
  "is_active": true,
  "sort_order": 100,
  "dimensions": {
    "heights_mm": [55, 65, 75],
    "depths_mm": [160, 300],
    "length_step_mm": 100
  },
  "meta": {
    "created_at": "2025-01-10T12:00:00Z",
    "updated_at": "2025-03-01T09:30:00Z",
    "data_version": "1.2.0"
  }
}
```

| Поле                        | Тип               | Обяз. | Nullable | Описание                                                                                                                                    |
| --------------------------- | ----------------- | ----- | -------- | ------------------------------------------------------------------------------------------------------------------------------------------- |
| `id`                        | string            | да    | нет      | Глобально уникальный идентификатор серии внутри IWDC. Стабильный, не зависит от языка и отображения. Рекомендуемый формат: `series.<slug>`. |
| `code`                      | string            | да    | нет      | Бизнес-код серии (например, `VK`, `VKV`, `VC`). Может совпадать с кодом в прайсе. Используется во внешних системах.                         |
| `slug`                      | string            | да    | нет      | Канонический машиночитаемый идентификатор серии. Используется как ключ связи с `models`, `lengths`, `seo`. Формат описан ниже.              |
| `title`                     | string            | да    | нет      | Основное человекочитаемое название серии (RU или основной язык проекта).                                                                    |
| `title_en`                  | string            | нет   | да       | Название серии на английском (или втором языке).                                                                                            |
| `short_title`               | string            | нет   | да       | Короткое имя/аббревиатура для UI. Если отсутствует — используется `title`.                                                                  |
| `description`               | string            | нет   | да       | Расширенное описание серии на основном языке. Может использоваться в карточках, лендингах, SEO.                                             |
| `description_en`            | string            | нет   | да       | Аналогичное описание на английском.                                                                                                         |
| `category`                  | string            | да    | нет      | Логическая категория серии (например, `heating_convector`, `radiator`, `accessory`). Используется для фильтрации и маршрутизации.           |
| `is_active`                 | boolean           | да    | нет      | Признак активной серии. `false` означает, что серия скрыта из публичных интерфейсов, но сохраняется для совместимости.                      |
| `sort_order`                | integer           | нет   | нет      | Числовой приоритет сортировки (меньше — выше). Если отсутствует, сортировка может производиться по `title` или `code`.                      |
| `dimensions`                | object            | нет   | да       | Аггрегированная информация о типичных габаритах серии (необязательна, но полезна для построения UI/фильтров).                               |
| `dimensions.heights_mm`     | integer[]         | нет   | да       | Список стандартных высот в миллиметрах, связанных с серией.                                                                                 |
| `dimensions.depths_mm`      | integer[]         | нет   | да       | Список стандартных глубин в миллиметрах.                                                                                                    |
| `dimensions.length_step_mm` | integer           | нет   | да       | Шаг длины (например, 100 мм). Необязателен.                                                                                                 |
| `meta`                      | object            | нет   | да       | Внутренняя служебная информация о серии.                                                                                                    |
| `meta.created_at`           | string (ISO 8601) | нет   | да       | Дата первого появления записи. Заполняется системой.                                                                                        |
| `meta.updated_at`           | string (ISO 8601) | нет   | да       | Последнее изменение записи.                                                                                                                 |
| `meta.data_version`         | string (SemVer)   | нет   | да       | Версия данных серии в терминах Data SemVer (например, `1.2.0`).                                                                             |

#### 4.1.4. Ограничения и инварианты

**Уникальность идентификаторов**

- `id` обязан быть уникален.
- `slug` обязан быть уникален.
- `code` должен быть уникален в домене применения.

**Формат slug**

- Только латинские буквы в нижнем регистре, цифры и точки.
- Pattern:

```
^[a-z0-9]+(?:\.[a-z0-9]+)*$
```

**Связь с другими слоями**

- `series.slug` является внешним ключом для:
  - `models[*].series_slug`
  - `seo[*].entity_slug` (series-level)

**Поле category**

- Может быть ограничено enum в JSON Schema.
- Расширение допустимо без MAJOR.

**Флаг is_active**

- При `false` серия остаётся в данных как архивная.

#### 4.1.5. Правила эволюции (Data SemVer для Series)

**MAJOR:**

- удаление обязательных полей;
- изменение их типов;
- изменение формата slug;
- переименование slug;
- перевод необязательного поля в обязательное.

**MINOR:**

- добавление необязательных полей;
- расширение enum;
- добавление новых Series.

**PATCH:**

- изменения текстов;
- обновления флагов;
- корректировки sort_order;
- обновление meta.*

#### 4.1.6. Пример валидного series.json

```json
[
  {
    "id": "series.vk",
    "code": "VK",
    "slug": "vk",
    "title": "Внутрипольные конвекторы VK",
    "title_en": "Floor convectors VK",
    "short_title": "VK",
    "description": "Серия встроенных в пол водяных конвекторов для систем отопления.",
    "description_en": "Series of floor-embedded water convectors for heating systems.",
    "category": "heating_convector",
    "is_active": true,
    "sort_order": 100,
    "dimensions": {
      "heights_mm": [55, 65, 75],
      "depths_mm": [160, 300],
      "length_step_mm": 100
    },
    "meta": {
      "created_at": "2025-01-10T12:00:00Z",
      "updated_at": "2025-03-01T09:30:00Z",
      "data_version": "1.2.0"
    }
  },
  {
    "id": "series.vkv",
    "code": "VKV",
    "slug": "vkv.24v",
    "title": "Внутрипольные конвекторы с вентилятором 24В",
    "title_en": "Floor convectors with fan 24V",
    "category": "heating_convector",
    "is_active": true
  }
]
```

### 4.2. Models Data Contract

#### 4.2.1. Назначение

Сущность Models представляет собой товарную модель (артикул в бизнес-логике).

Модель — основной элемент продуктового каталога:

- формирует slug-идентификатор;
- определяет конструктивные параметры;
- связывает категорию и серию с длинами (lengths);
- определяет все допустимые длины, форматы, типы исполнения;
- является источником SEO-данных второго уровня.

Внешние системы (Vitron 2.0 / Wilma 2.0 / Aleri / ArtMuse / API) используют Models как стабильный слой данных.

#### 4.2.2. Формат файла models.json

Файл `data/json/models/models.json` имеет структуру:

```json
[
  { /* Model object */ },
  { /* Model object */ }
]
```

- Тип корня: массив объектов
- Каждый объект — одна модель
- Порядок объектов не влияет на семантику

#### 4.2.3. Структура объекта Model

Общий вид объекта:

```json
{
  "id": "model.vk.65.200.2tg",
  "series_slug": "vk",
  "code": "ВК.65.200.2ТГ",
  "slug": "vk.65.200.2tg",
  "title": "ВК.65.200.2ТГ",
  "title_en": "VK.65.200.2TG",
  "description": "Описание модели...",
  "description_en": "Model description...",
  "height_mm": 65,
  "depth_mm": 200,
  "tube_count": 2,
  "type": "water",
  "subtype": "natural_convection",
  "is_active": true,
  "lengths_available_mm": [600, 700, 800, 900],
  "features": {
    "has_fan": false,
    "power_supply": null
  },
  "meta": {
    "created_at": "2025-01-12T12:00:00Z",
    "updated_at": "2025-03-01T09:30:00Z",
    "data_version": "1.2.0"
  }
}
```

| Поле                    | Тип               | Обяз. | Nullable | Описание                                                             |
| ----------------------- | ----------------- | ----- | -------- | -------------------------------------------------------------------- |
| `id`                    | string            | да    | нет      | Уникальный стабильный ID модели. Формат: `model.<slug>`.             |
| `series_slug`           | string            | да    | нет      | Связка с Series. Должен соответствовать `series.slug`.               |
| `code`                  | string            | да    | нет      | Бизнес-артикул модели (как в прайсе). Используется в SEO и UI.       |
| `slug`                  | string            | да    | нет      | Машиночитаемый идентификатор модели. Строго стабильный. Формат ниже. |
| `title`                 | string            | да    | нет      | Отображаемое название модели (RU). Обычно равно коду.                |
| `title_en`              | string            | нет   | да       | EN-название модели.                                                  |
| `description`           | string            | нет   | да       | Описание модели.                                                     |
| `description_en`        | string            | нет   | да       | English-описание модели.                                             |
| `height_mm`             | integer           | да    | нет      | Высота модели в мм.                                                  |
| `depth_mm`              | integer           | да    | нет      | Глубина модели в мм.                                                 |
| `tube_count`            | integer           | нет   | да       | Количество труб теплообменника.                                      |
| `type`                  | string            | да    | нет      | Тип оборудования (`water`, `water_fan`, `electric`, etc.).           |
| `subtype`               | string            | нет   | да       | Подтип (например, `natural_convection`, `fan_coil`).                 |
| `is_active`             | boolean           | да    | нет      | Активность модели. При false остаётся для совместимости.             |
| `lengths_available_mm`  | integer[]         | да    | нет      | Допустимые длины для этой модели. Связаны с `lengths`.               |
| `features`              | object            | нет   | да       | Доп. признаки модели.                                                |
| `features.has_fan`      | boolean           | нет   | да       | Есть ли вентилятор.                                                  |
| `features.power_supply` | string            | нет   | да       | Напряжение питания (например `24V`, `230V`).                         |
| `meta`                  | object            | нет   | да       | Служебные поля.                                                      |
| `meta.created_at`       | string (ISO 8601) | нет   | да       | Дата создания.                                                       |
| `meta.updated_at`       | string (ISO 8601) | нет   | да       | Дата обновления.                                                     |
| `meta.data_version`     | string (SemVer)   | нет   | да       | Версия данных модели.                                                |

#### 4.2.4. Ограничения и инварианты

**1. Уникальность**

- `id` — уникален в пределах файла.
- `slug` — уникален.
- `code` — уникален в рамках серии.

**2. Формат slug**

Slug модели должен следовать строгому паттерну:

```
<series_slug>.<height>.<depth>.<tube_code>
```

Пример:

```
vk.65.200.2tg
```

Паттерн:

```
^[a-z0-9]+(?:\.[a-z0-9]+)+$
```

**3. Жёсткая связь с Series**

- `series_slug` обязан существовать в `series.json`.
- Модель не может ссылаться на неактивную серию, если сама активна.

**4. Связь с Lengths**

- Каждый элемент `lengths_available_mm` должен иметь соответствующую запись в `lengths.json`.
- Длины, отсутствующие в списке, считаются недопустимыми.

**5. Физические параметры**

- `height_mm > 0`
- `depth_mm > 0`
- `tube_count >= 1` (если указано)
- Значения длины должны делиться на шаг серии (если серия определяет `length_step_mm`)

#### 4.2.5. Правила эволюции (Data SemVer для Models)

**MAJOR**

- изменение структуры slug;
- удаление обязательных полей (`series_slug`, `code`, `slug`, `height_mm`, `depth_mm`, `type`);
- изменение типа обязательных полей;
- переименование slug модели;
- изменение артикула `code`.

**MINOR**

- добавление необязательных полей;
- расширение `features`;
- добавление новых моделей;
- расширение допустимых значений `type`/`subtype`.

**PATCH**

- изменение описаний;
- исправление ошибок артикула, не затрагивающее slug;
- добавление/убирание отдельных длины в `lengths_available_mm`;
- обновление `meta`.

#### 4.2.6. Пример валидного models.json

```json
[
  {
    "id": "model.vk.65.200.2tg",
    "series_slug": "vk",
    "code": "ВК.65.200.2ТГ",
    "slug": "vk.65.200.2tg",
    "title": "ВК.65.200.2ТГ",
    "title_en": "VK.65.200.2TG",
    "height_mm": 65,
    "depth_mm": 200,
    "tube_count": 2,
    "type": "water",
    "subtype": "natural_convection",
    "is_active": true,
    "lengths_available_mm": [600, 700, 800, 900],
    "features": {
      "has_fan": false,
      "power_supply": null
    },
    "meta": {
      "created_at": "2025-01-12T12:00:00Z",
      "updated_at": "2025-03-01T09:30:00Z",
      "data_version": "1.2.0"
    }
  }
]
```

### 4.3. Lengths Data Contract

#### 4.3.1. Назначение

Сущность Lengths описывает конкретные длины моделей — физические варианты исполнения.

Этот слой является критическим элементом IWDC, потому что каждая длина:

- формирует конечную SKU (артикул третьего уровня);
- определяет тепловую мощность (Вт);
- содержит цену, специсполнения и параметры;
- участвует в SEO;
- используется в UI, фильтрах и расчётах;
- является частью стабильного URL.

Длина — самая изменяемая сущность в прайсах, поэтому Data Contract обеспечивает строгий контроль эволюции.

#### 4.3.2. Формат файла lengths.json

Файл расположен в:

```
data/json/lengths/lengths.json
```

Формат:

```json
[
  { /* Length object */ },
  { /* Length object */ }
]
```

- Тип корня: массив объектов
- Каждый объект соответствует одному сочетанию:
  - модель + длина

#### 4.3.3. Структура объекта Length

```json
{
  "id": "length.vk.65.200.2tg.900",
  "model_slug": "vk.65.200.2tg",
  "length_mm": 900,
  "heat_output_w": 178,
  "price_rub": {
    "side_connection": 14500,
    "bottom_connection": 15200
  },
  "options": {
    "stainless_steel": false,
    "galvanized": true,
    "fan_power_w": null
  },
  "meta": {
    "created_at": "2025-01-12T12:00:00Z",
    "updated_at": "2025-03-01T10:00:00Z",
    "data_version": "1.2.1"
  }
}
```

| Поле                          | Тип               | Обяз. | Nullable | Описание                                                        |
| ----------------------------- | ----------------- | ----- | -------- | --------------------------------------------------------------- |
| `id`                          | string            | да    | нет      | Уникальный ID длины. Формат: `length.<model_slug>.<length_mm>`. |
| `model_slug`                  | string            | да    | нет      | Ссылка на `models.slug`.                                        |
| `length_mm`                   | integer           | да    | нет      | Физическая длина модели.                                        |
| `heat_output_w`               | number            | да    | нет      | Теплоотдача в ваттах для данной длины.                          |
| `price_rub`                   | object            | да    | нет      | Цены для вариантов исполнения.                                  |
| `price_rub.side_connection`   | integer           | да    | нет      | Цена с боковым подключением.                                   |
| `price_rub.bottom_connection` | integer           | да    | нет      | Цена с нижним подключением.                                     |
| `options`                     | object            | нет   | да       | Конфигурационные параметры.                                     |
| `options.stainless_steel`     | boolean           | нет   | да       | Выполнение из нержавеющей стали.                                |
| `options.galvanized`          | boolean           | нет   | да       | Оцинкованное исполнение.                                        |
| `options.fan_power_w`         | number            | нет   | да       | Мощность вентилятора (если есть).                               |
| `meta`                        | object            | нет   | да       | Служебная информация.                                           |
| `meta.created_at`             | string (ISO 8601) | нет   | да       | Создание записи.                                                |
| `meta.updated_at`             | string (ISO 8601) | нет   | да       | Обновление записи.                                              |
| `meta.data_version`           | string (SemVer)   | нет   | да       | Версия данных длины.                                            |

#### 4.3.4. Ограничения и инварианты

**1. Уникальность**

- `id` — уникален в пределах файла.
- `model_slug + length_mm` — уникальная пара.
- Дублирование длины для одной модели запрещено.

**2. Жёсткая связь с Models**

- `model_slug` обязан присутствовать в `models.json`.
- Длина не может быть активной, если связанная модель — не активна.

**3. Ограничения длины**

- `length_mm > 0`
- Если серия модели указывает `length_step_mm`, то:
  - `length_mm % length_step_mm === 0`
- Длина обязана присутствовать в списке `models[lengths_available_mm]`.

**4. Теплоотдача**

- `heat_output_w > 0`
- Допускается число с плавающей точкой (иногда производители дают дробные значения).

**5. Цена**

- `side_connection` и `bottom_connection` должны быть:
  - целыми числами,
  - ≥ 0,
  - без копеек.

**6. Параметры options**

- Необязательны.
- Наличие флага `stainless_steel = true` может потребовать проверку со стороны Series Contract (опционально в v0.6).

#### 4.3.5. Правила эволюции (Data SemVer для Lengths)

**MAJOR**

- изменение структуры `id`;
- изменение формата slug-превращения модели;
- удаление длины из модели без миграции;
- изменение типа обязательных полей;
- изменение бизнес-логики цен или теплоты.

**MINOR**

- добавление новой длины к модели;
- добавление новых опций;
- расширение содержимого блока `options`;
- добавление новых моделей, а вместе с ними и длин.

**PATCH**

- обновление цены;
- поправка теплоотдачи;
- добавление или правка описаний `meta`;
- мелкие корректировки, не влияющие на slug/id.

#### 4.3.6. Пример валидного lengths.json

```json
[
  {
    "id": "length.vk.65.200.2tg.900",
    "model_slug": "vk.65.200.2tg",
    "length_mm": 900,
    "heat_output_w": 178,
    "price_rub": {
      "side_connection": 14500,
      "bottom_connection": 15200
    },
    "options": {
      "stainless_steel": false,
      "galvanized": true,
      "fan_power_w": null
    },
    "meta": {
      "created_at": "2025-01-12T12:00:00Z",
      "updated_at": "2025-03-01T10:00:00Z",
      "data_version": "1.2.1"
    }
  }
]
```

### 4.4. Meta Data Contract

#### 4.4.1. Назначение

Сущность Meta — это системный слой IWDC, обеспечивающий:

- стабильность данных во времени;
- фиксацию версии (Data SemVer);
- прослеживаемость изменений;
- корректную интеграцию с API, CMS, внешними системами;
- аналитические операции (когда изменилось, что изменилось, в какой сборке);
- юридическую прозрачность данных.

Meta — это основной механизм контроля качества IWDC.

Каждая сущность (Series, Models, Lengths, SEO) может включать собственный блок meta, а IWDC как платформа имеет глобальный meta-манифест.

#### 4.4.2. Уровни Meta

Meta состоит из двух уровней:

**1) Локальный meta-блок на уровне сущности**

Пример:

```json
"meta": {
  "created_at": "2025-03-01T09:30:00Z",
  "updated_at": "2025-03-05T10:00:00Z",
  "data_version": "1.3.0"
}
```

Этот блок присутствует в каждом объекте:

- series
- models
- lengths
- seo

**2) Глобальный системный meta-манифест**

Файл:

```
data/json/meta/iwdc-meta.json
```

Определяет:

- версию всего набора данных;
- дату сборки;
- контрольные суммы;
- используемые схемы;
- ссылки на предыдущие версии;
- diff-информацию (при необходимости).

#### 4.4.3. Локальная структура meta-блока

Полный формат:

```json
{
  "meta": {
    "created_at": "2025-03-01T09:30:00Z",
    "updated_at": "2025-03-05T10:00:00Z",
    "data_version": "1.3.0",
    "change_origin": "price-update",
    "integrity_hash": "sha256:abc123..."
  }
}
```

| Поле             | Тип               | Обяз. | Nullable | Описание                                                                                   |
| ---------------- | ----------------- | ----- | -------- | ------------------------------------------------------------------------------------------ |
| `created_at`     | string (ISO 8601) | нет   | да       | Дата первого появления сущности в IWDC.                                                    |
| `updated_at`     | string (ISO 8601) | нет   | да       | Дата последнего изменения данных сущности.                                                 |
| `data_version`   | string (SemVer)   | нет   | да       | Версия данных сущности. Контролируется SemVer.                                             |
| `change_origin`  | string            | нет   | да       | Источник изменения: `price-update`, `xls-import`, `manual-correction`, `script-migration`. |
| `integrity_hash` | string            | нет   | да       | Контрольная сумма содержимого сущности. Вычисляется build-процессом.                       |

#### 4.4.4. Глобальный meta-манифест IWDC

Файл: `iwdc-meta.json`

Пример:

```json
{
  "iwdc_data_version": "1.3.0",
  "generated_at": "2025-03-05T10:05:00Z",
  "previous_version": "1.2.9",
  "schema_versions": {
    "series": "2.0.0",
    "models": "2.0.0",
    "lengths": "2.0.0",
    "seo": "2.0.0"
  },
  "integrity": {
    "series_hash": "sha256:aa01...",
    "models_hash": "sha256:bb02...",
    "lengths_hash": "sha256:cc03...",
    "seo_hash": "sha256:dd04..."
  }
}
```

**Таблица полей**

| Поле                | Тип               | Обяз. | Описание                                    |
| ------------------- | ----------------- | ----- | ------------------------------------------- |
| `iwdc_data_version` | string (SemVer)   | да    | Глобальная версия IWDC-данных.              |
| `generated_at`      | string (ISO 8601) | да    | Дата и время сборки IWDC.                  |
| `previous_version`  | string            | нет   | Предыдущая версия для трекинга diff и changelog. |
| `schema_versions`   | object            | да    | Версии схем JSON Schema по слоям.          |
| `integrity`         | object            | да    | Контрольные суммы всех слоёв IWDC.          |

#### 4.4.5. Ограничения и инварианты

**1. created_at**

- После появления сущности не меняется никогда.
- Изменение требует MAJOR (по сути сущность считается новой).

**2. updated_at**

- Должно быть ≥ `created_at`.
- Меняется при любом PATCH/MINOR/MAJOR изменении.

**3. data_version**

- Обязательное соответствие Data SemVer:
  - `MAJOR.MINOR.PATCH`
- MAJOR — структурное изменение сущности.
- MINOR — добавление поля/опции.
- PATCH — корректировки данных, которые не влияют на структуру.

**4. integrity_hash**

- Вычисляется на основе сортированного JSON.
- Используется для выявления "тихих изменений".

**5. глобальная версия iwdc_data_version**

- Меняется при изменении любого сло́я контракта.
- Build должен валиться, если версия не соответствует diff.

#### 4.4.6. Правила эволюции (Data SemVer для Meta)

**MAJOR**

- изменение структуры meta-блока;
- изменение структуры `iwdc-meta.json`;
- удаление полей meta;
- изменение типов.

**MINOR**

- добавление новых необязательных полей;
- добавление смены структур внутри `integrity`.

**PATCH**

- обновления дат;
- обновление версий данных;
- обновление хэшей;
- фиксация изменения значений сущности.

#### 4.4.7. Пример валидного iwdc-meta.json

```json
{
  "iwdc_data_version": "1.3.0",
  "generated_at": "2025-03-05T10:05:00Z",
  "previous_version": "1.2.9",
  "schema_versions": {
    "series": "2.0.0",
    "models": "2.0.0",
    "lengths": "2.0.0",
    "seo": "2.0.0"
  },
  "integrity": {
    "series_hash": "sha256:a1",
    "models_hash": "sha256:b2",
    "lengths_hash": "sha256:c3",
    "seo_hash": "sha256:d4"
  }
}
```

### 4.5. SEO Data Contract

#### 4.5.1. Назначение

Слой SEO определяет полный набор поисковых, структурных и описательных параметров для всех сущностей IWDC:

- Series
- Models
- Lengths

SEO-контракт гарантирует:

- стабильность SEO-структур при обновлении данных;
- предсказуемость параметров для Vitron 2.0, Wilma 2.0, Aleri;
- корректную генерацию title/description/H1/OG/JSON-LD;
- отсутствие "тихих" изменений, ломающих ранжирование;
- совместимость с Data SemVer;
- машинную проверяемость SEO-данных.

SEO становится частью Data Platform, а не "мягким слоем".

#### 4.5.2. Формат файла seo.json

Путь:

```
data/json/seo/seo.json
```

Формат:

```json
[
  { /* SEO object */ },
  { /* SEO object */ }
]
```

Каждый объект относится к одной сущности:

- Series / Model / Length.

#### 4.5.3. Структура объекта SEO

```json
{
  "id": "seo.vk.65.200.2tg.900",
  "entity_type": "length",
  "entity_slug": "vk.65.200.2tg.900",
  "title": "ВК.65.200.2ТГ — 900 мм | Внутрипольный конвектор отопления водяной",
  "description": "Конвектор длиной 900 мм с теплоотдачей 178 Вт для систем водяного отопления...",
  "h1": "ВК.65.200.2ТГ, 900 мм",
  "keywords": [
    "внутрипольный конвектор",
    "конвектор отопления",
    "vk 65 200",
    "2тг",
    "900 мм"
  ],
  "og": {
    "title": "ВК.65.200.2ТГ — 900 мм",
    "description": "Внутрипольный конвектор водяного отопления, длина 900 мм.",
    "image": "/og/vk/65/200/2tg/900.jpg"
  },
  "json_ld": {
    "@context": "https://schema.org",
    "@type": "Product",
    "name": "ВК.65.200.2ТГ (900 мм)",
    "sku": "VK.65.200.2TG.900",
    "category": "HeatingEquipment"
  },
  "meta": {
    "created_at": "2025-03-05T10:10:00Z",
    "updated_at": "2025-03-05T10:10:00Z",
    "data_version": "1.0.0"
  }
}
```

**Таблица полей**

| Поле             | Тип      | Обяз. | Nullable | Описание                                                             |
| ---------------- | -------- | ----- | -------- | -------------------------------------------------------------------- |
| `id`             | string   | да    | нет      | Уникальный ID SEO-записи. Формат: `seo.<entity_slug>`.               |
| `entity_type`    | string   | да    | нет      | `series` / `model` / `length`.                                       |
| `entity_slug`    | string   | да    | нет      | Cсылка на slug сущности. Должна существовать в соответствующем слое. |
| `title`          | string   | да    | нет      | SEO Title страницы.                                                  |
| `description`    | string   | нет   | да       | SEO description.                                                     |
| `h1`             | string   | да    | нет      | Главный заголовок страницы.                                          |
| `keywords`       | string[] | нет   | да       | Массив SEO-ключей.                                                   |
| `og`             | object   | нет   | да       | Набор параметров OpenGraph.                                          |
| `og.title`       | string   | нет   | да       | Заголовок OG.                                                        |
| `og.description` | string   | нет   | да       | Описание OG.                                                         |
| `og.image`       | string   | нет   | да       | Путь к OG-изображению.                                               |
| `json_ld`        | object   | нет   | да       | Структура JSON-LD Product/Article.                                   |
| `meta`           | object   | нет   | да       | Стандартный meta-блок IWDC.                                          |

#### 4.5.4. Ограничения и инварианты

**1. entity_slug**

- Должен соответствовать slug в `series`, `models` или `lengths`.
- Тип сущности определяется `entity_type`.

**2. Уникальность**

- Один `entity_slug` → одна SEO-запись.
- Дубли запрещены.

**3. Наследование SEO**

Стандарт IWDC определяет:

- Series SEO — базовый уровень.
- Model SEO — может наследовать часть полей Series.
- Length SEO — может наследовать часть Model + Series.

Наследование не является автоматическим — оно применяется build-скриптом.

**4. Ограничения title**

- длина ≤ 70 символов;
- допускается автоматическая подстановка длины и артикула;
- формат должен быть стабильным для сущности.

**5. Ограничения description**

- длина ≤ 160–180 символов;
- должен содержать артикул или длину для моделей/длин.

**6. Ограничения h1**

- всегда должен содержать читаемое название сущности:
  - серия → имя серии;
  - модель → артикул;
  - длина → артикул + длину.

**7. Ограничения OG**

В `og.image` запрещены:

- абсолютные URL;
- нестабильные пути;
- параметры запроса.

#### 4.5.5. Правила эволюции (Data SemVer для SEO)

**MAJOR**

- изменение структуры SEO-объекта;
- переименование обязательных полей (`title`, `h1`);
- изменение slug сущности (влияет на `id` SEO);
- удаление SEO-объектов без редиректов (контракт запрещает).

**MINOR**

- добавление новых необязательных полей (например, `og.locale`);
- расширение JSON-LD схем;
- добавление ключевых слов.

**PATCH**

- обновление текстов (`title`/`description`/`h1`);
- корректировка OG изображений;
- SEO-оптимизация описаний;
- изменение `keywords`.

PATCH не ломает SEO-контракт.

#### 4.5.6. Пример валидного seo.json

```json
[
  {
    "id": "seo.vk.65.200.2tg.900",
    "entity_type": "length",
    "entity_slug": "vk.65.200.2tg.900",
    "title": "ВК.65.200.2ТГ — 900 мм | Внутрипольный конвектор отопления водяной",
    "description": "Конвектор длиной 900 мм с теплоотдачей 178 Вт для систем водяного отопления.",
    "h1": "ВК.65.200.2ТГ, 900 мм",
    "keywords": [
      "внутрипольный конвектор",
      "конвектор отопления",
      "vk 65 200",
      "2тг",
      "900 мм"
    ],
    "og": {
      "title": "ВК.65.200.2ТГ — 900 мм",
      "description": "Внутрипольный конвектор водяного отопления, длина 900 мм.",
      "image": "/og/vk/65/200/2tg/900.jpg"
    },
    "json_ld": {
      "@context": "https://schema.org",
      "@type": "Product",
      "name": "ВК.65.200.2ТГ (900 мм)",
      "sku": "VK.65.200.2TG.900",
      "category": "HeatingEquipment"
    },
    "meta": {
      "created_at": "2025-03-05T10:10:00Z",
      "updated_at": "2025-03-05T10:10:00Z",
      "data_version": "1.0.0"
    }
  }
]
```